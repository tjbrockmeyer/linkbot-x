---
kind: pipeline
name:  test-build-master 
type: docker
trigger:
  branch:
    - master
  event:
    - push
  paths:
    - package*.json
    - tsconfig.json
    - src/**/*.ts
    - .config.json
    - docker/Dockerfile
steps:
  - name: test
    when:
      paths:
        include:
          - '*'
        exclude:
          - docker/Dockerfile
    image: node:18.15.0
    commands:
      - npm ci
      - npm run test:ci
  - name: build
    image: plugins/docker:20.14.0
    settings:
      repo: cr.teabee.dev/${DRONE_REPO}
      tags: latest
      dockerfile: docker/Dockerfile
      cache_from: cr.teabee.dev/${DRONE_REPO}:latest

---
kind: pipeline
name:  test-build-tag 
type: docker
trigger:
  event:
    - tag
  action:
    - create
steps:
  - name: test
    image: node:18.15.0
    commands:
      - npm ci
      - npm run test:ci
  - name: build
    image: plugins/docker:20.14.0
    settings:
      repo: cr.teabee.dev/${DRONE_REPO}
      tags: ${DRONE_TAG}
      dockerfile: docker/Dockerfile
      cache_from: cr.teabee.dev/${DRONE_REPO}:latest

---
kind: pipeline
name: deploy-tag
type: docker
trigger:
  ref:
    - refs/tags/v*
  event:
    - promote
    - rollback
  target:
    - production
steps:
  - name: copy compose file
    image: appleboy/drone-scp:1.6.6
    settings:
      host: teabee.dev
      username: tyler
      key:
        from_secret: sshKey
      passphrase:
        from_secret: sshKeyPassphrase
      source: "docker/compose.home-server.yml"
      target: /tmp/${DRONE_REPO}
      overwrite: true
  - name: deploy
    image: appleboy/drone-ssh:1.6.10
    settings:
      host: teabee.dev
      username: tyler
      key:
        from_secret: sshKey
      passphrase:
        from_secret: sshKeyPassphrase
      script:
        - cd /home/tyler/lab/deployments/
        - mkdir -p ${DRONE_REPO}
        - cd ${DRONE_REPO}
        - mv /tmp/${DRONE_REPO}/docker/compose.home-server.yml compose.yml
        - IMAGE_TAG=${DRONE_TAG} docker compose up -d
