---
kind: pipeline
name: test and build
type: docker
trigger:
  ref:
    - refs/heads/master
    - refs/tags/v*
  event:
    - push
    - tag
steps:
  - name: test
    image: node:18.15.0
    commands:
      - npm ci
      - npm run test:ci
    when:
      paths:
        - 'package*.json'
        - 'tsconfig.json'
        - 'src/**/*.ts'
        - '.config.json'
  - &build-latest
    name: build-latest
    image: plugins/docker
    settings:
      repo: cr.teabee.dev/linkbot
      tags: ${DRONE_TAG:-latest}
      dockerfile: docker/Dockerfile
      cache_from: cr.teabee.dev/linkbot:latest
    when:
      branch:
        - master
      paths:
        - 'package*.json'
        - 'tsconfig.json'
        - 'src/**/*.ts'
        - '.config.json'
        - 'docker/Dockerfile'
  - <<: *build-latest
    name: build-tag
    when:
      event:
        - tag

---
kind: pipeline
name: deploy
type: docker
trigger:
  event:
    - promote
    - rollback
  target:
    - production
steps:
  - name: deployment check
    image: bash
    environment:
      TAG: ${DRONE_TAG}
    commands:
      - $${TAG:?only tagged releases are deployable to production}
  - name: copy compose file
    image: appleboy/drone-scp:1.6.6
    settings:
      host: teabee.dev
      username: tyler
      key:
        from_secret: sshKey
      passphrase:
        from_secret: sshKeyPassphrase
      source: docker/compose.home-server.yml
      target: /tmp/${DRONE_REPO}
      overwrite: true
  - name: deploy
    image: appleboy/drone-ssh:1.6.10
    settings:
      host: teabee.dev
      username: tyler
      key:
        from_secret: sshKey
      passphrase:
        from_secret: sshKeyPassphrase
      script:
        - cd /home/tyler/lab/deployments/
        - mv /tmp/${DRONE_REPO}/docker/compose.home-server.yml ${DRONE_REPO_NAME}.yml
        - LINKBOT_VERSION=${DRONE_TAG} docker compose -p ${DRONE_REPO_NAME} -f ${DRONE_REPO_NAME}.yml up -d
