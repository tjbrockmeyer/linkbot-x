---
kind: pipeline
name: test and build
type: docker
trigger:
  branch:
    - master
  event:
    - push
  paths:
    - 'package*.json'
    - 'tsconfig.json'
    - 'src/**/*.ts'
    - '.config.json'
    - 'docker/Dockerfile'
steps:
  - name: test
    when:
      paths:
        include: [ '*' ]
        exclude: [ 'docker/Dockerfile' ]
    image: node:18.15.0
    commands:
      - npm ci
      - npm run test:ci
  - name: build-latest
    image: plugins/docker
    settings:
      repo: cr.teabee.dev/linkbot
      tags: latest
      dockerfile: docker/Dockerfile
      cache_from: cr.teabee.dev/linkbot:latest

---
kind: pipeline
name: test and build tag
type: docker
trigger:
  event:
    - tag
  action:
    - create
steps:
  - name: test
    image: node:18.15.0
    commands:
      - npm ci
      - npm run test:ci
  - name: build-tag
    image: plugins/docker
    settings:
      repo: cr.teabee.dev/linkbot
      tags: ${DRONE_TAG}
      dockerfile: docker/Dockerfile
      cache_from: cr.teabee.dev/linkbot:latest

---
kind: pipeline
name: deploy
type: docker
trigger:
  ref:
    - refs/tags/v*
  event:
    - promote
    - rollback
  target:
    - production
steps:
  - name: copy compose file
    image: appleboy/drone-scp:1.6.6
    settings:
      host: teabee.dev
      username: tyler
      key:
        from_secret: sshKey
      passphrase:
        from_secret: sshKeyPassphrase
      source: docker/compose.home-server.yml
      target: /tmp/${DRONE_REPO}
      overwrite: true
  - name: deploy
    image: appleboy/drone-ssh:1.6.10
    settings:
      host: teabee.dev
      username: tyler
      key:
        from_secret: sshKey
      passphrase:
        from_secret: sshKeyPassphrase
      script:
        - cd /home/tyler/lab/deployments/
        - mv /tmp/${DRONE_REPO}/docker/compose.home-server.yml ${DRONE_REPO_NAME}.yml
        - LINKBOT_VERSION=${DRONE_TAG} docker compose -p ${DRONE_REPO_NAME} -f ${DRONE_REPO_NAME}.yml up -d
